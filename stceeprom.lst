C51 COMPILER V9.60.0.0   STCEEPROM                                                         12/27/2023 11:38:56 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE STCEEPROM
OBJECT MODULE PLACED IN .\hex\stceeprom.obj
COMPILER INVOKED BY: C:\Keil_C51\C51\BIN\C51.EXE Source\stceeprom.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PR
                    -INT(.\stceeprom.lst) TABS(2) OBJECT(.\hex\stceeprom.obj)

line level    source

   1           
   2          #include "main.h"
   3          #include <intrins.H>
   4           
   5          //===================================================================================
   6          //                   ç”¨æˆ·æ¥å£å‡½æ•°
   7          //
   8          // ç”±äºSTC12C5A60S2 EEPROMåŒºçš„ç‰¹æ®Šæ€§, åªèƒ½ä¸€æ•´æ‰‡åŒº(512å­—èŠ‚)å†™,ä¸èƒ½å•å­—èŠ‚æ›´æ”¹.
   9          // ç‰¹åŠ å…¥ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°, ä»¥æ”¯æŒå•å­—èŠ‚æ›´æ”¹
  10          // ç”¨æˆ·æ— éœ€å…³å¿ƒæ‰‡åŒºæ“¦é™¤ç­‰æ“ä½œ ä½†é¢å¤–éœ€è¦ä¸€æ‰‡åŒºä½œä¸ºç¼“å­˜ä»¥å‡å°‘RAMå ç”¨(æ—¶é—´æ
             -¢ç©ºé—´^_^)
  11          // STC12C5A60S2 EEPROMåŒºä¸º1024å­—èŠ‚, å…±2ä¸ªæ‰‡åŒº æ¯æ‰‡åŒº512å­—èŠ‚
  12          // å»é™¤ç”¨ä½œç¼“å­˜çš„ç¬¬äºŒæ‰‡åŒº,ç”¨æˆ·å¯ç”¨æ•°æ®ä¸º512ä¸ª åœ°å€èŒƒå›´:0-511
  13          //===================================================================================
  14          #define MaxEepromNum    512
  15          
  16          // è¯»å–STC EEPROM
  17          U8 STC_EE_Read(U16 Addr, U8 *Buf, U16 Num)
  18          {
  19   1          U16 i;
  20   1          // å‚æ•°æ£€æµ‹
  21   1          if((Addr+Num) > MaxEepromNum)return FALSE;
  22   1      
  23   1          for(i=0;i<Num;i++)
  24   1          {
  25   2              Buf[i] = Byte_Read(Addr+i);
  26   2          }
  27   1          return TRUE;
  28   1      }
  29          
  30          
  31          // å†™å…¥STC EEPROM
  32          U8 STC_EE_Write(U16 Addr, U8 *Buf, U16 Num)
  33          {
  34   1          U16 i;
  35   1          U8  tmp;
  36   1      
  37   1          // å‚æ•°æ£€æµ‹
  38   1          if((Addr+Num) > MaxEepromNum)return FALSE;
  39   1      
  40   1          // æ“¦é™¤æ‰‡åŒº2 
  41   1          Sector_Erase(MaxEepromNum);                    // æ“¦é™¤ç¬¬2æ‰‡åŒº
  42   1          // å¤åˆ¶ç¬¬1æ‰‡åŒºæ•°æ®åˆ°ç¬¬2æ‰‡åŒºå¤‡ä»½
  43   1          for(i=0;i<MaxEepromNum;i++)
  44   1          {
  45   2              tmp = Byte_Read(i);                 // è¯»EEPROMçš„å€¼
  46   2              Byte_Program(i+MaxEepromNum, tmp);         // å†™å…¥ EEPROM
  47   2          }
  48   1          // æ“¦é™¤æ‰‡åŒº1 
  49   1          Sector_Erase(0x00);                     // æ“¦é™¤ç¬¬1æ‰‡åŒº
  50   1          // æ¢å¤ç¬¬2æ‰‡åŒºæ•°æ®åˆ°ç¬¬1æ‰‡åŒº
  51   1          for(i=0;i<Addr;i++)
  52   1          {
  53   2              tmp = Byte_Read(i+MaxEepromNum);           // è¯»EEPROMçš„å€¼
C51 COMPILER V9.60.0.0   STCEEPROM                                                         12/27/2023 11:38:56 PAGE 2   

  54   2              Byte_Program(i, tmp);               // å†™å…¥ EEPROM
  55   2          }
  56   1          // å†™å…¥è¦ä¿å­˜çš„æ•°æ®
  57   1          for(i=Addr;i<Addr+Num;i++)
  58   1          {
  59   2              Byte_Program(i, Buf[i-Addr]);       // å†™å…¥ EEPROM
  60   2          }
  61   1          // ç»§ç»­æ¢å¤ç¬¬2æ‰‡åŒºæ•°æ®åˆ°ç¬¬1æ‰‡åŒº
  62   1          for(i=Addr+Num;i<MaxEepromNum;i++)
  63   1          {
  64   2              tmp = Byte_Read(i+MaxEepromNum);           // è¯»EEPROMçš„å€¼
  65   2              Byte_Program(i, tmp);               // å†™å…¥ EEPROM
  66   2          }
  67   1          return TRUE;
  68   1      }
  69          
  70          
  71          
  72          
  73          
  74          //===================================================================================
  75          //    åŸºç¡€å‡½æ•° æ¥è‡ªå®æ™¶ç½‘ç«™
  76          //===================================================================================
  77          
  78          
  79          //å®šä¹‰Flash æ“ä½œç­‰å¾…æ—¶é—´åŠå…è®¸IAP/ISP/EEPROM æ“ä½œçš„å¸¸æ•°
  80          //#define ENABLE_ISP 0x80 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<30MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  81          //#define ENABLE_ISP 0x81 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<24MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  82          #define ENABLE_ISP 0x82 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<20MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  83          //#define ENABLE_ISP 0x83 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<12MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  84          //#define ENABLE_ISP 0x84 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<6MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  85          //#define ENABLE_ISP 0x85 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<3MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  86          //#define ENABLE_ISP 0x86 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<2MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  87          //#define ENABLE_ISP 0x87 //ç³»ç»Ÿå·¥ä½œæ—¶é’Ÿ<1MHz æ—¶ï¼Œå¯¹IAP_CONTR å¯„å­˜å™¨è®¾ç½®æ­¤å€¼
  88          
  89          //#define DEBUG_DATA               0x5A  //æœ¬æµ‹è¯•ç¨‹åºæœ€ç»ˆå­˜å‚¨åœ¨ EEPROM å•å…ƒçš„æ•°å€¼
  90          //#define DATA_FLASH_START_ADDRESS 0x0400  //STC5Axx ç³»åˆ— EEPROM æµ‹è¯•èµ·å§‹åœ°å€
  91          
  92          union union_temp16
  93          {
  94              U16 un_temp16;
  95              U8  un_temp8[2];
  96          }my_unTemp16;
  97          
  98          
  99          //è¯»ä¸€å­—èŠ‚ï¼Œè°ƒç”¨å‰éœ€æ‰“å¼€IAP åŠŸèƒ½ï¼Œå…¥å£:DPTR = å­—èŠ‚åœ°å€ï¼Œè¿”å›:A = è¯»å‡ºå­—èŠ‚
 100          U8 Byte_Read(U16 add)
 101          {
 102   1          IAP_DATA = 0x00;
 103   1          IAP_CONTR = ENABLE_ISP;         //æ‰“å¼€IAP åŠŸèƒ½, è®¾ç½®Flash æ“ä½œç­‰å¾…æ—¶é—´
 104   1          IAP_CMD = 0x01;                 //IAP/ISP/EEPROM å­—èŠ‚è¯»å‘½ä»¤
 105   1      
 106   1          my_unTemp16.un_temp16 = add;
 107   1          IAP_ADDRH = my_unTemp16.un_temp8[0];    //è®¾ç½®ç›®æ ‡å•å…ƒåœ°å€çš„é«˜8 ä½åœ°å€
 108   1          IAP_ADDRL = my_unTemp16.un_temp8[1];    //è®¾ç½®ç›®æ ‡å•å…ƒåœ°å€çš„ä½8 ä½åœ°å€
 109   1      
 110   1          //EA = 0;
 111   1          IAP_TRIG = 0x5A;   //å…ˆé€ 5Ah,å†é€A5h åˆ°ISP/IAP è§¦å‘å¯„å­˜å™¨,æ¯æ¬¡éƒ½éœ€å¦‚æ­¤
 112   1          IAP_TRIG = 0xA5;   //é€å®ŒA5h åï¼ŒISP/IAP å‘½ä»¤ç«‹å³è¢«è§¦å‘èµ·åŠ¨
 113   1          _nop_();
 114   1          //EA = 1;
 115   1          IAP_Disable();  //å…³é—­IAP åŠŸèƒ½, æ¸…ç›¸å…³çš„ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨,ä½¿CPU å¤„äºå®‰å…¨çŠ¶æ€,
C51 COMPILER V9.60.0.0   STCEEPROM                                                         12/27/2023 11:38:56 PAGE 3   

 116   1                          //ä¸€æ¬¡è¿ç»­çš„IAP æ“ä½œå®Œæˆä¹‹åå»ºè®®å…³é—­IAP åŠŸèƒ½,ä¸éœ€è¦æ¯æ¬¡éƒ½å…³
 117   1          return (IAP_DATA);
 118   1      }
 119          
 120          //å­—èŠ‚ç¼–ç¨‹ï¼Œè°ƒç”¨å‰éœ€æ‰“å¼€IAP åŠŸèƒ½ï¼Œå…¥å£:DPTR = å­—èŠ‚åœ°å€, A= é¡»ç¼–ç¨‹å­—èŠ‚çš„æ•°æ®
 121          void Byte_Program(U16 add, U8 ch)
 122          {
 123   1          IAP_CONTR = ENABLE_ISP;         //æ‰“å¼€ IAP åŠŸèƒ½, è®¾ç½®Flash æ“ä½œç­‰å¾…æ—¶é—´
 124   1          IAP_CMD = 0x02;                 //IAP/ISP/EEPROM å­—èŠ‚ç¼–ç¨‹å‘½ä»¤
 125   1      
 126   1          my_unTemp16.un_temp16 = add;
 127   1          IAP_ADDRH = my_unTemp16.un_temp8[0];    //è®¾ç½®ç›®æ ‡å•å…ƒåœ°å€çš„é«˜8 ä½åœ°å€
 128   1          IAP_ADDRL = my_unTemp16.un_temp8[1];    //è®¾ç½®ç›®æ ‡å•å…ƒåœ°å€çš„ä½8 ä½åœ°å€
 129   1      
 130   1          IAP_DATA = ch;                  //è¦ç¼–ç¨‹çš„æ•°æ®å…ˆé€è¿›IAP_DATA å¯„å­˜å™¨
 131   1          //EA = 0;
 132   1          IAP_TRIG = 0x5A;   //å…ˆé€ 5Ah,å†é€A5h åˆ°ISP/IAP è§¦å‘å¯„å­˜å™¨,æ¯æ¬¡éƒ½éœ€å¦‚æ­¤
 133   1          IAP_TRIG = 0xA5;   //é€å®ŒA5h åï¼ŒISP/IAP å‘½ä»¤ç«‹å³è¢«è§¦å‘èµ·åŠ¨
 134   1          _nop_();
 135   1          //EA = 1;
 136   1          IAP_Disable();  //å…³é—­IAP åŠŸèƒ½, æ¸…ç›¸å…³çš„ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨,ä½¿CPU å¤„äºå®‰å…¨çŠ¶æ€,
 137   1                          //ä¸€æ¬¡è¿ç»­çš„IAP æ“ä½œå®Œæˆä¹‹åå»ºè®®å…³é—­IAP åŠŸèƒ½,ä¸éœ€è¦æ¯æ¬¡éƒ½å…³
 138   1      }
 139          
 140          //æ“¦é™¤æ‰‡åŒº, å…¥å£:DPTR = æ‰‡åŒºåœ°å€
 141          void Sector_Erase(U16 add)
 142          {
 143   1          IAP_CONTR = ENABLE_ISP;         //æ‰“å¼€IAP åŠŸèƒ½, è®¾ç½®Flash æ“ä½œç­‰å¾…æ—¶é—´
 144   1          IAP_CMD = 0x03;                 //IAP/ISP/EEPROM æ‰‡åŒºæ“¦é™¤å‘½ä»¤
 145   1      
 146   1          my_unTemp16.un_temp16 = add;
 147   1          IAP_ADDRH = my_unTemp16.un_temp8[0];    //è®¾ç½®ç›®æ ‡å•å…ƒåœ°å€çš„é«˜8 ä½åœ°å€
 148   1          IAP_ADDRL = my_unTemp16.un_temp8[1];    //è®¾ç½®ç›®æ ‡å•å…ƒåœ°å€çš„ä½8 ä½åœ°å€
 149   1      
 150   1          //EA = 0;
 151   1          IAP_TRIG = 0x5A;   //å…ˆé€ 5Ah,å†é€A5h åˆ°ISP/IAP è§¦å‘å¯„å­˜å™¨,æ¯æ¬¡éƒ½éœ€å¦‚æ­¤
 152   1          IAP_TRIG = 0xA5;   //é€å®ŒA5h åï¼ŒISP/IAP å‘½ä»¤ç«‹å³è¢«è§¦å‘èµ·åŠ¨
 153   1          _nop_();
 154   1          //EA = 1;
 155   1          IAP_Disable();  //å…³é—­IAP åŠŸèƒ½, æ¸…ç›¸å…³çš„ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨,ä½¿CPU å¤„äºå®‰å…¨çŠ¶æ€,
 156   1                          //ä¸€æ¬¡è¿ç»­çš„IAP æ“ä½œå®Œæˆä¹‹åå»ºè®®å…³é—­IAP åŠŸèƒ½,ä¸éœ€è¦æ¯æ¬¡éƒ½å…³
 157   1      }
 158          
 159          void IAP_Disable()
 160          {
 161   1          //å…³é—­IAP åŠŸèƒ½, æ¸…ç›¸å…³çš„ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨,ä½¿CPU å¤„äºå®‰å…¨çŠ¶æ€,
 162   1          //ä¸€æ¬¡è¿ç»­çš„IAP æ“ä½œå®Œæˆä¹‹åå»ºè®®å…³é—­IAP åŠŸèƒ½,ä¸éœ€è¦æ¯æ¬¡éƒ½å…³
 163   1          IAP_CONTR = 0;      //å…³é—­IAP åŠŸèƒ½
 164   1          IAP_CMD   = 0;      //æ¸…å‘½ä»¤å¯„å­˜å™¨,ä½¿å‘½ä»¤å¯„å­˜å™¨æ— å‘½ä»¤,æ­¤å¥å¯ä¸ç”¨
 165   1          IAP_TRIG  = 0;      //æ¸…å‘½ä»¤è§¦å‘å¯„å­˜å™¨,ä½¿å‘½ä»¤è§¦å‘å¯„å­˜å™¨æ— è§¦å‘,æ­¤å¥å¯ä¸ç”¨
 166   1          IAP_ADDRH = 0;
 167   1          IAP_ADDRL = 0;
 168   1      }
 169          
 170          void Write_Set_T(float dat) //å†™å…¥å½“å‰çš„äº®åº¦å€¼
 171          {
 172   1          U8  Buf[2];
 173   1        dat *= 10;
 174   1        Buf[0] =  ((int)dat>>8)&0X00FF;  //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 175   1        Buf[1] =  (int)dat&0X00FF;     //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 176   1        STC_EE_Write(0x00,Buf,2);  //byte 00  01
 177   1      }
C51 COMPILER V9.60.0.0   STCEEPROM                                                         12/27/2023 11:38:56 PAGE 4   

 178          
 179          float Read_Set_T(void)  //è¯»å‡ºå…³ç¯å‰çš„äº®åº¦å€¼
 180          {
 181   1          U16 dat_H,dat_L;
 182   1        float DAT;
 183   1        U8  Buf[2];
 184   1        STC_EE_Read(0x00,Buf,2);  //byte 00  01
 185   1        dat_H = (Buf[0]<<8)&0Xff00;   //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 186   1        dat_L =  Buf[1]&0X00ff;     //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 187   1        DAT = dat_H |  dat_L;
 188   1        DAT /= 10;
 189   1        return DAT;
 190   1      }
 191          
 192          //void Write_ON_OFF_Time(U16 dat) //å†™å…¥å¼€å…³æœºæ¬¡æ•°
 193          //{
 194          //    U8  Buf[2];
 195          //  Buf[0] =  (dat>>8)&0X00FF;   //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 196          //  Buf[1] =   dat&0X00FF;     //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 197          //  STC_EE_Write(0x02,Buf,2);  //byte 02  03
 198          //}
 199          //
 200          //U16 Read_ON_OFF_Time(void)  //è¯»å‡ºå¼€å…³æœºæ¬¡æ•°
 201          //{
 202          //    U16 dat_H,dat_L,DAT;
 203          //  U8  Buf[2];
 204          //  STC_EE_Read(0x02,Buf,2);  //byte 02  03
 205          //  dat_H = (Buf[0]<<8)&0Xff00;   //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 206          //  dat_L =  Buf[1]&0X00ff;     //é—è·¨å–é‹å©šå¹é”Ÿ?8å¨´ï½æ‹·
 207          //  DAT = dat_H |  dat_L;
 208          //  return DAT;
 209          //}
 210          
 211          
 212          
 213          
 214          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    797    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2      31
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
